<html>
<head>
</head>
<body>
<pre>The <span style="color:red">urchins</span> eat the kelp / And the <span style="color:green">kelp</span> will cease to be
If the <span style="color:red">urchin's</span> weren't eaten / By the playful <span style="color:blue">otterees</span>
(Double Click to start)</pre>
<canvas id=canvas>
<script>
 window.requestAnimationFrame = window.requestAnimationFrame
                           || window.webkitRequestAnimationFrame
                           || window.mozRequestAnimationFrame
                           || window.msRequestAnimationFrame
                           || function(func) { setTimeout(func, 16); };
window.body = document.body; 
ctx = canvas.getContext("2d");
canvas.width = W = 750;
canvas.height =H = 660;

balls = [];
grasC = 0;
urchC = 0;
oterC = 0;

BALL = function(){
    this.x = this.y = this.r = 0;
    this.c = "BLACK";
};
GRASS = function(){
    grasC++;
    this.a = Math.floor(Math.random()*400); this.phase = 0;
    this.x = Math.random() * W;
    this.y = Math.random() * H;
    this.r = 10;
    this.c = "GREEN";
    this.edge();
    this.space(GRASS,30);
    if (Math.random()*Math.exp(grasC/3)<1) balls.push(new GRASS());
};
urchinoldest = 2500;
urchinreproduce = 100;
urchinwaitime = 75;
urchinhungrytime = 750;
URCHIN = function() {
    urchC++;
    this.a = this.phase = this.h = 0;
    this.x = Math.random() * W;
    this.y = Math.random() * H;
    this.r = 10;
    this.c = "RED";
    this.space(URCHIN,50);
    if (grasC < urchC*9/10) this.a = -1000;
    if (Math.random()*Math.exp(urchC)<1) balls.push(new URCHIN());
}
otteroldest = 3000;
otterwaitime = 150;
otterhungrytime = 200;
OTTER = function() {
    oterC++;
    this.eat = this.a = this.phase = this.h = 0;
    this.x = Math.random() * W;
    this.y = Math.random() * H;
    this.r = 10;
    this.c = "BLUE";
    this.space(OTTER,100);
    if (urchC < oterC*9/10) this.a = -1000;
};

phases = [ROAM = 0, CONS = 1, REPR = 2];
GRASS.prototype.space = URCHIN.prototype.space = OTTER.prototype.space = function(kind,d2){
    var item;
    if (item = this.type(kind)){
        if (this.calc(item) < d2*d2)
            this.a = -1000; 
    }
};

BALL.prototype.calc = function(ball) {
    var dx = this.x - ball.x;
    var dy = this.y - ball.y;
    return dx*dx + dy*dy;
};
BALL.prototype.coll = function(ball) {
    var dx = this.x - ball.x;
    var dy = this.y - ball.y;
    var rr = this.r + ball.r;
    return dx*dx + dy*dy < rr*rr;
};
BALL.prototype.draw = function(){
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.r,0,2*Math.PI);
    ctx.fillStyle = this.c;
    ctx.fill();
};
BALL.prototype.edge = function(){
    if (this.x-this.r < 0) {this.x = 2*this.r-this.x;}
    if (this.x+this.r > W) {this.x = 2*(W-this.r)-this.x;}
    if (this.y-this.r < 0) {this.y = 2*this.r-this.y;}
    if (this.y+this.r > H) {this.y = 2*(H-this.r)-this.y;}
};
BALL.prototype.type = function(TYPE) {
    var save = undefined;
    var savecalc = Infinity;
    for (var i=0; i<balls.length; i++) {
        var it = balls[i];
        if (it === this) continue;
        if (it instanceof TYPE) {
            var ii = this.calc(it);
            if (ii < savecalc) {
                save = it;
                savecalc = ii;
            }
        }
    }
    return save;
};

OTTER.prototype.calc = URCHIN.prototype.calc = GRASS.prototype.calc = BALL.prototype.calc;
OTTER.prototype.coll = URCHIN.prototype.coll = GRASS.prototype.coll = BALL.prototype.coll;
OTTER.prototype.draw = URCHIN.prototype.draw = GRASS.prototype.draw = BALL.prototype.draw;
OTTER.prototype.edge = URCHIN.prototype.edge = GRASS.prototype.edge = BALL.prototype.edge;
OTTER.prototype.type = URCHIN.prototype.type = GRASS.prototype.type = BALL.prototype.type;

URCHIN.prototype.tograss = function(d) {
    var grass;
    if (grass = this.type(GRASS)) {
        var dx = grass.x - this.x;
        var dy = grass.y - this.y;
        var r = Math.sqrt(dx*dx + dy*dy);
        if (r < 10) {
            grass.a = -1000;
            this.h = this.a;
            this.phase = REPR;
        }
        this.x += d*dx/r;
        this.y += d*dy/r;
    }
}
URCHIN.prototype.awayotter = function(d) {
    var otter;
    if (otter = this.type(OTTER)) {
        var dx = otter.x - this.x;
        var dy = otter.y - this.y;
        var r = Math.sqrt(dx*dx + dy*dy);
        if (r < 200) {                
            this.x -= d*dx/r;
            this.y -= d*dy/r;
        }
        this.edge();
    }
}
OTTER.prototype.tourchin = function(d){
    var orcin;
    if (orcin = this.type(URCHIN)) {
        var dx = orcin.x - this.x;
        var dy = orcin.y - this.y;
        var r = Math.sqrt(dx*dx + dy*dy);
        if (r < 10) {
            this.eat++;
            orcin.a = -1000;
            this.h = this.a;
            if (this.eat > 1 || Math.random() < .3) {
                this.eat = 0;
                this.phase = REPR;
            }
        }
        this.x += d*dx/r;
        this.y += d*dy/r;
    }
};
newotter = false;
OTTER.prototype.tootter = function(d) {
    var otter;
    if (otter = this.type(OTTER)) {
        var dx = otter.x - this.x;
        var dy = otter.y - this.y;
        var r = Math.sqrt(dx*dx + dy*dy);
        if (r < 10) {
            if (newotter) balls.push(new OTTER());
            newotter=!newotter;
            this.h = this.a;
            this.phase = ROAM;
        }
        this.x += d*dx/r;
        this.y += d*dy/r;
    }
}

GRASS.prototype.move = function() {
    this.a++;
    if (this.a < 0) return;
    if (this.a % 333 === 0) balls.push(new GRASS());
    if (grasC>6 && this.a > 2000) this.a = -1000;
}
URCHIN.prototype.move = function() {
    this.a++;
    if (urchC>4 && this.a > urchinoldest) this.a = -1000;
    switch (this.phase) {
        case ROAM:
            if (this.a - this.h > urchinwaitime) {
                this.phase = CONS;
                this.h = this.a;
            }
            this.awayotter(.5);
        break;
        case CONS:
            if (urchC>4 && this.a-this.h > urchinhungrytime) this.a = -1000;
            var x=this.x,y=this.y;
            this.awayotter(.2);
            this.tograss(.3);
            var dx=this.x-x,dy=this.y-y;
            var r = Math.sqrt(dx*dx + dy*dy);
            this.x += .5*dx/r;
            this.y += .5*dy/r;
        break;
        case REPR:
            this.awayotter(.3);
            if (this.a-this.h > urchinreproduce) {
               balls.push(new URCHIN());
               this.h = this.a;
               this.phase = ROAM;
            }
        break;
    }
}
OTTER.prototype.move = function() {
    this.a++;
    if (oterC > 2 && this.a > otteroldest) this.a = -1000;
    switch (this.phase) {
    case ROAM:
        if (this.a-this.h > otterwaitime) {
            this.phase = CONS;
            this.h = this.a;
        }
    break;
    case CONS:
        if (oterC > 2 && this.a-this.h>otterhungrytime) this.a = -1000;
        this.tourchin(1.4);
    break;
    case REPR:
        this.tootter(2);
    break;
    }
}

POINT = function(y,c) {
    this.x = 700;
    this.y = y;
    this.c = c;
}
POINT.prototype.draw= function() {
    ctx.beginPath();
    ctx.arc(this.x,this.y,1,0,2*Math.PI);
    ctx.fillStyle = this.c;
    ctx.fill();
}

points = []
count = 0
bars = function() {
    if (++count > 10) {
        for (var i=0; i<points.length;i++) {
            if (--points[i].x < 100)
                points.splice(i--,1);
        }
        points.push(new POINT(grasC,"GREEN"));
        points.push(new POINT(urchC,"RED"));
        points.push(new POINT(oterC,"BLUE"));
        count = 0;
    }
    for (var i=0; i<points.length;i++)
    points[i].draw();

    ctx.fillStyle = "GREEN";
    ctx.fillRect(0,0,20,grasC); 
    ctx.fillStyle = "RED";
    ctx.fillRect(20,0,20,urchC); 
    ctx.fillStyle = "BLUE";
    ctx.fillRect(40,0,20,oterC);    
}

f=function(){
    ctx.clearRect(0,0,W,H);
    ctx.beginPath(); ctx.rect(0,0,W-1,H-1); ctx.stroke();
    for (var i=0; i<balls.length; i++) {
        balls[i].move();
        if (balls[i].a < 0) {
            if (balls[i] instanceof GRASS) {
                grasC--;
            } else if (balls[i] instanceof URCHIN) {
                urchC--;
            } else if (balls[i] instanceof OTTER) {
                oterC--;
            }
            balls.splice(i--,1);
        }
    }
    for (var i=0; i<balls.length; i++) balls[i].draw();
    bars();
    requestAnimationFrame(f);
}
document.body.ondblclick = function(){
    if (grasC < 12) { for (var i=0;i<12;i++) balls.push(new GRASS()); }
    if (urchC < 8) { for (var i=0;i<8;i++) balls.push(new URCHIN());}
    if (oterC < 4) { for (var i=0;i<4;i++) balls.push(new OTTER()); }
};
f();
</script>
</body>
</html>